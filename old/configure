#!/bin/bash

function unknown_option {
	echo "Unknown option: $1"
	echo "Run ./configure --help to get help"
	exit 1
}

function run_clean {
	echo "Are you sure to delete release/debug builds? (yes or no)"
	read yesorno;
	if [ "$yesorno" == "yes" ]; then
		echo "Removing release and debug builds"
		rm -rf release debug
	fi
	exit 0
}
function run_cleanall {
echo "Are you sure to delete all builds (release, debug, deps)? (yes or no)"
	read yesorno;
	if [ "$yesorno" == "yes" ]; then
		echo "Removing all builds"
		rm -rf release debug deps
	fi
	exit 0
}

RELEASE_DIR=release
DEBUG_DIR=debug

PACKAGE_PATH=/home/minerva/shared/minerva_packages
DEPS_PATH=$PWD/deps
MKL_ROOT=/opt/intel/composer_xe_2013.4.183/mkl
CFLAGS=""

while [ $# -gt 0 ]
do
	case $1 in
		-help | --help | -h | --h)
			want_help=yes ;;
		--clean)
			run_clean=yes ;;
		--cleanall)
			run_cleanall=yes ;;
		--mkl=*)
			MKL_ROOT=`expr "x$1" : "x--mkl=\(.*\)"` ;;
		--packages=*)
			PACKAGE_PATH=`expr "x$1" : "x--packages=\(.*\)"` ;;
		-D)
			CFLAGS="$CFLAGS -D $2"; shift ;;
		-D*)
			CFLAGS="$CFLAGS -D `expr "x$1" : "x-D\(.*\)"`" ;;
		*)	unknown_option $1 ;;
	esac
	shift
done

#echo $want_help
#echo $run_clean
#echo $HAS_MKL
#echo $MKL_ROOT
#echo $CFLAGS

#================================ help description =============================
if test "x$want_help" = xyes; then
	cat <<EOF
Usage: ./configure [OPTION]...
Configurations:
	-h, --help              Display this help and exit
	--clean                 Clean up debug and release build
	--cleanall              Clean all bulids including dependent libraries
	--mkl=MKL_ROOT           Specify the root of MKL installation
	--packages=DIR          Specify the location of dependent packages of Minerva
	-Dvar=value             Specify definitions to be passed on to cmake
EOF
exit 0;
fi

#test -n "$want_help" && exit 0
#===============================================================================

#================================ clean build =============================
if test "x$run_clean" = xyes; then
	run_clean;
fi
if test "x$run_cleanall" = xyes; then
	run_cleanall;
fi
#===============================================================================

#================================ MKL configuration =============================
if [ -d $MKL_ROOT ]; then
	echo "Found MKL in $MKL_ROOT"
	CFLAGS="$CFLAGS \
		-D MKL_FOUND \
		-D MKL_ROOT=$MKL_ROOT \
		-D MKL_INCLUDE_PATH=$MKL_ROOT/include \
		-D MKL_LIBRARY_PATH=$MKL_ROOT/lib/intel64/ \
		-D INTEL_LIBRARY_PATH=$MKL_ROOT/../compiler/lib/intel64"
fi
#===============================================================================

#================================ copy dependency =============================
#echo "copy the dependency package files from $PACKAGE_PATH"
BOOST_LIB=$PACKAGE_PATH/boost_1_54_0.tar.gz
BZIP2_LIB=$PACKAGE_PATH/bzip2-1.0.6.tar.gz
EVENT_LIB=$PACKAGE_PATH/libevent-2.0.18-stable.tar.gz
GPERF_LIB=$PACKAGE_PATH/gperftools-2.0.tar.gz
#MTL_LIB=$PACKAGE_PATH/MTL-4.0.9261-Linux.tar.gz

if [ -f $BOOST_LIB ]; then
	echo "copy boost library from $BOOST_LIB"
	cp -v $BOOST_LIB $DEPS_PATH/boost/src/
fi
if [ -f $BZIP2_LIB ]; then
	echo "copy libbz2 from $BZIP2_LIB"
	cp -v $BZIP2_LIB $DEPS_PATH/libbz2/src/
fi
if [ -f $EVENT_LIB ]; then
	echo "copy libevent from $EVENT_LIB"
	cp -v $EVENT_LIB $DEPS_PATH/event/src/
fi
if [ -f $GPERF_LIB ]; then
	echo "copy gperftools from $GPERF_LIB"
	cp -v $GPERF_LIB $DEPS_PATH/gperftools/src/
fi
#if [ -f $MTL_LIB ]; then
	#echo "copy mtl from $MTL_LIB"
	#cp -v $MTL_LIB $DEPS_PATH/mtl/src/
#fi
#===============================================================================

#================================ main configuration =============================
echo -e "\n\n\n========================== Release =========================="
if [ ! -d $RELEASE_DIR ]; then
	mkdir $RELEASE_DIR 
fi
cd $RELEASE_DIR
cmake -D CMAKE_BUILD_TYPE=Release $CFLAGS ..
cd ..

echo -e "\n\n\n========================== Debug =========================="
if [ ! -d $DEBUG_DIR ]; then
	mkdir $DEBUG_DIR 
fi
cd $DEBUG_DIR
cmake -D CMAKE_BUILD_TYPE=Debug $CFLAGS ..
cd ..

