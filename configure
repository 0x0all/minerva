#!/bin/bash

function unknown_option {
	echo "Unknown option: $1"
	echo "Run ./configure --help to get help"
	exit 1
}

function run_clean {
	echo "Are you sure to delete release/debug builds? (yes or no)"
	read yesorno;
	if [ "$yesorno" == "yes" ]; then
		echo "Removing release and debug builds"
		rm -rf release debug
	fi
	exit 0
}
function run_cleanall {
echo "Are you sure to delete all builds (release, debug, deps)? (yes or no)"
	read yesorno;
	if [ "$yesorno" == "yes" ]; then
		echo "Removing all builds"
		rm -rf release debug deps
	fi
	exit 0
}

source configure.in
EXTERNAL_LIB_PATH="$MKL_LIB_PATH,$GLOG_LIB_PATH,$BOOST_LIB_PATH,$GFLAGS_LIB_PATH"
EXTERNAL_INCLUDE_PATH="$MKL_INCLUDE_PATH,$GLOG_INCLUDE_PATH,$BOOST_INCLUDE_PATH,$GFLAGS_INCLUDE_PATH"
CXXFLAGS="$CXXFLAGS \
  -DEXTERNAL_LIB_PATH=$EXTERNAL_LIB_PATH\
  -DEXTERNAL_INCLUDE_PATH=$EXTERNAL_INCLUDE_PATH"

while [ $# -gt 0 ]
do
	case $1 in
		-help | --help | -h | --h)
			want_help=yes ;;
		--clean)
			run_clean=yes ;;
		--cleanall)
			run_cleanall=yes ;;
		--mkl=*)
			MKL_ROOT=`expr "x$1" : "x--mkl=\(.*\)"` ;;
		-D)
			CXXFLAGS="$CXXFLAGS -D $2"; shift ;;
		-D*)
			CXXFLAGS="$CXXFLAGS -D `expr "x$1" : "x-D\(.*\)"`" ;;
		*)	unknown_option $1 ;;
	esac
	shift
done

#echo $want_help
#echo $run_clean
#echo $HAS_MKL
#echo $MKL_ROOT
#echo $CXXFLAGS

#================================ help description =============================
if test "x$want_help" = xyes; then
	cat <<EOF
Usage: ./configure [OPTION]...
Configurations:
	-h, --help              Display this help and exit
	--clean                 Clean up debug and release build
	--cleanall              Clean all bulids including dependent libraries
	--mkl=MKL_ROOT           Specify the root of MKL installation
	--packages=DIR          Specify the location of dependent packages of Minerva
	-Dvar=value             Specify definitions to be passed on to cmake
EOF
exit 0;
fi

#test -n "$want_help" && exit 0
#===============================================================================

#================================ clean build =============================
if test "x$run_clean" = xyes; then
	run_clean;
fi
if test "x$run_cleanall" = xyes; then
	run_cleanall;
fi
#===============================================================================

#================================ MKL configuration =============================
#if [ -d $MKL_ROOT ]; then
#	echo "Found MKL in $MKL_ROOT"
#	CXXFLAGS="$CXXFLAGS \
#		-DMKL_FOUND=1 \
#		-DMKL_ROOT=$MKL_ROOT \
#		-DMKL_INCLUDE_PATH=$MKL_ROOT/include \
#		-DMKL_LIBRARY_PATH=$MKL_ROOT/lib/intel64/ \
#		-DINTEL_LIBRARY_PATH=$MKL_ROOT/../compiler/lib/intel64"
#fi
#===============================================================================

#============================== external libraries =============================
#echo "copy the dependency package files from $PACKAGE_PATH"
#MTL_LIB=$PACKAGE_PATH/MTL-4.0.9261-Linux.tar.gz
#if [ -f $MTL_LIB ]; then
	#echo "copy mtl from $MTL_LIB"
	#cp -v $MTL_LIB $DEPS_PATH/mtl/src/
#fi
#===============================================================================

#================================ main configuration =============================
echo -e "\n\n\n========================== Release =========================="
if [ ! -d $RELEASE_DIR ]; then
	mkdir $RELEASE_DIR
fi
cd $RELEASE_DIR
CXX=$CXX_COMPILER cmake -DCMAKE_BUILD_TYPE=Release $CXXFLAGS ..
cd ..

echo -e "\n\n\n========================== Debug =========================="
if [ ! -d $DEBUG_DIR ]; then
	mkdir $DEBUG_DIR
fi
cd $DEBUG_DIR
CXX=$CXX_COMPILER cmake -DCMAKE_BUILD_TYPE=Debug $CXXFLAGS ..
cd ..

